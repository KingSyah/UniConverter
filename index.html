<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcane Converter • Traditional, Standard & Fantasy Units</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --surface: #1a1a1a;
            --text: #e0e0e0;
            --text-secondary: #aaaaaa;
            --accent: #00d4ff;
            --accent-dark: #00a8cc;
            --border: #333333;
            --success: #4ade80;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 640px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2.25rem;
            font-weight: 700;
            background: linear-gradient(90deg, #00d4ff, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .filter-btn:hover {
            background: #252525;
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            font-weight: 600;
        }

        .converter {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input[type="number"] {
            width: 100%;
            background: #111;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 1rem;
            font-size: 1.75rem;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
        }

        select {
            width: 100%;
            background: #111;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 1rem;
            font-size: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
        }

        .swap {
            display: flex;
            justify-content: center;
            margin: -1rem 0 1rem;
        }

        .swap button {
            width: 48px;
            height: 48px;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--accent);
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .swap button:hover {
            background: var(--accent);
            color: #000;
            transform: rotate(180deg) scale(1.1);
        }

        .result {
            background: #111;
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1rem;
            border: 1px solid var(--border);
            min-height: 80px;
            display: flex;
            align-items: center;
        }

        #output {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--accent);
            word-break: break-all;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .precision-control {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .precision-control label {
            margin: 0;
            font-size: 0.875rem;
        }

        input[type="number"].precision {
            width: 70px;
            padding: 0.5rem;
            font-size: 1rem;
            background: #111;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
        }

        .add-custom {
            padding: 0.75rem 1.25rem;
            background: #111;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 9999px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-left: auto;
        }

        .add-custom:hover {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 16px;
            width: 100%;
            max-width: 420px;
            padding: 1.75rem;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px -10px rgba(0, 0, 0, 0.6);
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            background: #111;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.75rem;
            border-radius: 10px;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-buttons button {
            flex: 1;
            padding: 0.875rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cancel-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .cancel-btn:hover {
            background: #252525;
        }

        .add-btn {
            background: var(--accent);
            color: #000;
            border: none;
        }

        .add-btn:hover {
            background: var(--accent-dark);
        }

        .info {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.875rem;
            }
            
            #output {
                font-size: 1.75rem;
            }

            input[type="number"] {
                font-size: 1.5rem;
                padding: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Arcane Converter</h1>
            <p class="subtitle">Traditional • Standard • Fantasy measurement systems</p>
        </header>

        <div class="filters" id="filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="standard">Standard</button>
            <button class="filter-btn" data-filter="traditional">Traditional</button>
            <button class="filter-btn" data-filter="fantasy">Fantasy</button>
        </div>

        <div class="converter">
            <div class="input-group">
                <label for="inputValue">Value</label>
                <input type="number" id="inputValue" min="0" step="any" value="1" placeholder="Enter value">
            </div>

            <div class="input-group">
                <label for="fromUnit">From</label>
                <select id="fromUnit"></select>
                <div class="info" id="fromInfo"></div>
            </div>

            <div class="swap">
                <button id="swapBtn" aria-label="Swap units">⇄</button>
            </div>

            <div class="input-group">
                <label for="toUnit">To</label>
                <select id="toUnit"></select>
                <div class="info" id="toInfo"></div>
            </div>

            <div class="result">
                <div id="output">--</div>
            </div>

            <div class="controls">
                <div class="precision-control">
                    <label for="precision">Decimals</label>
                    <input type="number" id="precision" class="precision" value="4" min="0" max="10">
                </div>
                <button class="add-custom" id="addCustomBtn">+ Add Custom Unit</button>
            </div>
        </div>
    </div>

    <!-- Add Custom Unit Modal -->
    <div class="modal" id="customModal">
        <div class="modal-content">
            <h2>Add Custom Unit</h2>
            
            <div class="form-group">
                <label for="customName">Unit Name</label>
                <input type="text" id="customName" placeholder="e.g. Mana Crystal">
            </div>
            
            <div class="form-group">
                <label for="customGrams">Grams per Unit</label>
                <input type="number" id="customGrams" step="any" placeholder="e.g. 125.5">
            </div>
            
            <div class="form-group">
                <label for="customCategory">Category</label>
                <select id="customCategory">
                    <option value="standard">Standard</option>
                    <option value="traditional">Traditional</option>
                    <option value="fantasy" selected>Fantasy</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="customDesc">Description (optional)</label>
                <textarea id="customDesc" placeholder="Brief explanation of the unit"></textarea>
            </div>
            
            <div class="modal-buttons">
                <button class="cancel-btn" id="cancelCustom">Cancel</button>
                <button class="add-btn" id="confirmAdd">Add Unit</button>
            </div>
        </div>
    </div>

    <script>
        // Unit definitions - normalized to grams
        // Key: internal id, value: {name, factor (grams per 1 unit), category, description}
        let units = {
            gram: {
                name: "Gram",
                factor: 1,
                category: "standard",
                description: ""
            },
            kilogram: {
                name: "Kilogram",
                factor: 1000,
                category: "standard",
                description: ""
            },
            ounce: {
                name: "Ounce",
                factor: 28.349523125,
                category: "standard",
                description: ""
            },
            pound: {
                name: "Pound",
                factor: 453.59237,
                category: "standard",
                description: ""
            },
            jin: {
                name: "Jin",
                factor: 500,
                category: "traditional",
                description: "Chinese catty / traditional jin (0.5 kg)"
            },
            mayam: {
                name: "Mayam",
                factor: 3.33,
                category: "traditional",
                description: "Traditional Malay unit ≈ 3.33 grams"
            },
            tahil: {
                name: "Tahil",
                factor: 37.8,
                category: "traditional",
                description: "Malay/Chinese tael ≈ 37.8 grams"
            },
            kupang: {
                name: "Kupang",
                factor: 0.64,
                category: "traditional",
                description: "Small traditional Malay unit ≈ 0.64 grams"
            },
            manaStone: {
                name: "Mana Stone",
                factor: 150,
                category: "fantasy",
                description: "Magical crystal infused with mana energy (≈150g)"
            },
            dragonScale: {
                name: "Dragon Scale",
                factor: 8,
                category: "fantasy",
                description: "Shed scale from an ancient dragon (≈8g)"
            },
            heroWeightUnit: {
                name: "HWU",
                factor: 70000,
                category: "fantasy",
                description: "Hero Weight Unit - weight of a legendary hero (70 kg)"
            }
        };

        let currentFilter = 'all';

        const inputValueEl = document.getElementById('inputValue');
        const fromUnitEl = document.getElementById('fromUnit');
        const toUnitEl = document.getElementById('toUnit');
        const precisionEl = document.getElementById('precision');
        const outputEl = document.getElementById('output');
        const swapBtn = document.getElementById('swapBtn');
        const addCustomBtn = document.getElementById('addCustomBtn');
        const customModal = document.getElementById('customModal');
        const confirmAddBtn = document.getElementById('confirmAdd');
        const cancelCustomBtn = document.getElementById('cancelCustom');
        const customNameEl = document.getElementById('customName');
        const customGramsEl = document.getElementById('customGrams');
        const customCategoryEl = document.getElementById('customCategory');
        const customDescEl = document.getElementById('customDesc');

        // Helper to create option element
        function createOption(key, unit) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = unit.name;
            if (unit.description) {
                option.title = unit.description;
            }
            return option;
        }

        // Populate both selects based on current filter
        function populateSelects() {
            const fromSelect = fromUnitEl;
            const toSelect = toUnitEl;

            const oldFrom = fromSelect.value;
            const oldTo = toSelect.value;

            fromSelect.innerHTML = '';
            toSelect.innerHTML = '';

            if (currentFilter === 'all') {
                const categories = ['standard', 'traditional', 'fantasy'];
                
                for (let cat of categories) {
                    const catUnits = Object.entries(units)
                        .filter(([_, unit]) => unit.category === cat);
                    
                    if (catUnits.length === 0) continue;

                    const optgroup = document.createElement('optgroup');
                    optgroup.label = cat.charAt(0).toUpperCase() + cat.slice(1) + ' Units';

                    // Sort by name
                    catUnits.sort((a, b) => a[1].name.localeCompare(b[1].name));

                    for (let [key, unit] of catUnits) {
                        const option = createOption(key, unit);
                        optgroup.appendChild(option);
                    }

                    fromSelect.appendChild(optgroup);
                    
                    // Clone optgroup for toSelect
                    const toOptgroup = optgroup.cloneNode(true);
                    toSelect.appendChild(toOptgroup);
                }
            } else {
                // Specific category - flat list
                const catUnits = Object.entries(units)
                    .filter(([_, unit]) => unit.category === currentFilter);
                
                catUnits.sort((a, b) => a[1].name.localeCompare(b[1].name));

                for (let [key, unit] of catUnits) {
                    const fromOpt = createOption(key, unit);
                    fromSelect.appendChild(fromOpt);

                    const toOpt = createOption(key, unit);
                    toSelect.appendChild(toOpt);
                }
            }

            // Restore previous selections if still valid
            restoreSelection(fromSelect, oldFrom);
            restoreSelection(toSelect, oldTo);

            // If no selection made, pick first available
            if (!fromSelect.value && fromSelect.options.length > 0) {
                fromSelect.selectedIndex = 0;
            }
            if (!toSelect.value && toSelect.options.length > 0) {
                toSelect.selectedIndex = 0;
            }

            convert();
        }

        // Try to restore previous selection key if it still matches filter
        function restoreSelection(select, oldKey) {
            if (!oldKey) return;
            
            const unit = units[oldKey];
            if (!unit) return;

            if (currentFilter === 'all' || unit.category === currentFilter) {
                select.value = oldKey;
            }
        }

        // Main conversion logic
        function convert() {
            const inputStr = inputValueEl.value.trim();
            const inputVal = parseFloat(inputStr);
            
            if (isNaN(inputVal) || inputStr === '') {
                outputEl.textContent = '--';
                return;
            }

            const fromKey = fromUnitEl.value;
            const toKey = toUnitEl.value;

            if (!fromKey || !toKey || !units[fromKey] || !units[toKey]) {
                outputEl.textContent = '--';
                return;
            }

            const fromFactor = units[fromKey].factor;
            const toFactor = units[toKey].factor;

            let result = inputVal * (fromFactor / toFactor);

            const decimals = parseInt(precisionEl.value) || 4;
            const clampedDecimals = Math.min(Math.max(decimals, 0), 10);

            const formatted = result.toFixed(clampedDecimals);
            
            // Add unit name
            outputEl.textContent = `${formatted} ${units[toKey].name}`;
        }

        // Swap from and to units
        function swapUnits() {
            const fromVal = fromUnitEl.value;
            const toVal = toUnitEl.value;
            
            if (fromVal && toVal) {
                fromUnitEl.value = toVal;
                toUnitEl.value = fromVal;
                convert();
            }
        }

        // Open custom unit modal
        function openCustomModal() {
            customNameEl.value = '';
            customGramsEl.value = '';
            customDescEl.value = '';
            customCategoryEl.value = 'fantasy';
            customModal.style.display = 'flex';
            
            // Focus first field
            setTimeout(() => customNameEl.focus(), 100);
        }

        // Close modal
        function closeCustomModal() {
            customModal.style.display = 'none';
        }

        // Add custom unit
        function addCustomUnit() {
            const name = customNameEl.value.trim();
            const gramsStr = customGramsEl.value.trim();
            const category = customCategoryEl.value;
            const description = customDescEl.value.trim();

            if (!name) {
                alert('Please enter a unit name');
                customNameEl.focus();
                return;
            }

            const grams = parseFloat(gramsStr);
            if (isNaN(grams) || grams <= 0) {
                alert('Please enter a valid positive weight in grams');
                customGramsEl.focus();
                return;
            }

            // Generate safe key
            let key = name.toLowerCase()
                .replace(/\s+/g, '_')
                .replace(/[^a-z0-9_]/g, '');
            
            if (!key) {
                key = 'custom_' + Date.now().toString(36);
            }

            // Check for duplicate key
            if (units.hasOwnProperty(key)) {
                alert('A unit with this key already exists. Please choose a different name.');
                return;
            }

            // Add to units
            units[key] = {
                name: name,
                factor: grams,
                category: category,
                description: description || `Custom unit: ${name}`
            };

            closeCustomModal();
            
            // Refresh selects
            populateSelects();
            
            // Optional: select the new unit in from
            setTimeout(() => {
                if (fromUnitEl.options.length > 0) {
                    // Try to find the new one
                    for (let i = 0; i < fromUnitEl.options.length; i++) {
                        if (fromUnitEl.options[i].value === key) {
                            fromUnitEl.value = key;
                            convert();
                            return;
                        }
                    }
                }
            }, 10);
        }

        // Setup event listeners
        function setupListeners() {
            // Live conversion
            inputValueEl.addEventListener('input', convert);
            fromUnitEl.addEventListener('change', convert);
            toUnitEl.addEventListener('change', convert);
            precisionEl.addEventListener('input', convert);

            // Swap
            swapBtn.addEventListener('click', swapUnits);

            // Filter buttons
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update active state
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    currentFilter = btn.dataset.filter;
                    populateSelects();
                });
            });

            // Custom unit
            addCustomBtn.addEventListener('click', openCustomModal);
            cancelCustomBtn.addEventListener('click', closeCustomModal);
            confirmAddBtn.addEventListener('click', addCustomUnit);

            // Close modal on outside click
            customModal.addEventListener('click', (e) => {
                if (e.target === customModal) {
                    closeCustomModal();
                }
            });

            // Keyboard support for modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && customModal.style.display === 'flex') {
                    closeCustomModal();
                }
                if (e.key === 'Enter' && customModal.style.display === 'flex') {
                    if (document.activeElement.tagName !== 'TEXTAREA') {
                        addCustomUnit();
                    }
                }
            });
        }

        // Initialize
        function init() {
            setupListeners();
            
            // Set initial defaults
            fromUnitEl.value = 'gram';   // Will be overridden by populate if needed
            toUnitEl.value = 'kilogram';
            
            populateSelects();
            
            // Initial conversion with default value 1
            setTimeout(() => {
                inputValueEl.value = '1';
                convert();
            }, 50);
        }

        // Start the app
        window.onload = init;
    </script>
</body>
</html>